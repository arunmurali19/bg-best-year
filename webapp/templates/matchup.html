{% extends "base.html" %}

{% block title %}{{ match.year_a }} vs {{ match.year_b }} - What's the Good Year?{% endblock %}

{% block content %}
<p class="matchup-back-link"><a href="/">&larr; Back to all matchups</a></p>
<div class="mobile-back-bar"><a href="/">&larr; All matchups</a></div>

{# Determine display order to match bracket view (odd match_ids flip year_b to left) #}
{% if flip %}
    {% set left_year = match.year_b %}
    {% set right_year = match.year_a %}
    {% set games_left = games_b %}
    {% set games_right = games_a %}
{% else %}
    {% set left_year = match.year_a %}
    {% set right_year = match.year_b %}
    {% set games_left = games_a %}
    {% set games_right = games_b %}
{% endif %}

<h2 class="matchup-title">{{ round_name }}: {{ left_year }} vs {{ right_year }}</h2>

{# Countdown timer (only for active, unfinished matches with a deadline set) #}
{% if voting_deadline and match.is_active and not match.winner %}
<div class="deadline-timer" id="deadline-timer" data-deadline="{{ voting_deadline }}">
    <span id="timer-text">Loading countdown...</span>
</div>
{% endif %}

{# Status banner: results (if revealed), already-voted notice (if not revealed) #}
{% if results %}
{% if flip %}
{% set left_pct = results.pct_b %}
{% set right_pct = results.pct_a %}
{% else %}
{% set left_pct = results.pct_a %}
{% set right_pct = results.pct_b %}
{% endif %}
<div class="results-banner" id="results-banner">
    <div class="result-row">
        <div class="result-side-label">
            <strong>{{ left_year }}</strong>
            <span>{{ left_pct }}%</span>
        </div>
        <div class="result-bar">
            <div class="bar-fill bar-a" style="width: {{ left_pct }}%"></div>
            <div class="bar-fill bar-b" style="width: {{ right_pct }}%"></div>
        </div>
        <div class="result-side-label right-label">
            <span>{{ right_pct }}%</span>
            <strong>{{ right_year }}</strong>
        </div>
    </div>
    <p class="vote-count">{{ results.total }} total vote{{ 's' if results.total != 1 }}</p>
</div>
{% elif user_voted and not match.winner %}
<div class="voted-notice" id="results-banner">
    {% if voter_finalized %}
    <p><strong>&#10003; Your vote is locked in.</strong></p>
    <p class="voted-subtext">Results will be revealed by the admin after the round ends.</p>
    {% else %}
    <p><strong>&#10003; You voted for {{ user_voted }}.</strong></p>
    <p class="voted-subtext">You can still change your pick below till the deadline.</p>
    {% endif %}
</div>
{% endif %}

{# Head-to-head tier comparison bars (left year = blue, right year = red) #}
{% set top25_l  = games_left|selectattr('rank', 'le', 25)|list|length %}
{% set top200_l = games_left|selectattr('rank', 'le', 200)|list|length %}
{% set total_l  = games_left|length %}
{% set top25_r  = games_right|selectattr('rank', 'le', 25)|list|length %}
{% set top200_r = games_right|selectattr('rank', 'le', 200)|list|length %}
{% set total_r  = games_right|length %}
<div class="tier-comparison">
    <div class="tier-comparison-header">
        <span class="tc-year-label">{{ left_year }}</span>
        <span class="tc-year-label tc-year-right">{{ right_year }}</span>
    </div>
    {% set t25 = top25_l + top25_r %}
    {% if t25 > 0 %}
    <div class="tier-bar-row">
        <span class="tier-bar-label rank-gold">Top 25</span>
        <span class="tier-bar-count count-left">{{ top25_l }}</span>
        <div class="tier-bar">
            <div class="tier-fill fill-left" style="width: {{ (top25_l / t25 * 100)|round(1) }}%"></div>
            <div class="tier-fill fill-right" style="width: {{ (top25_r / t25 * 100)|round(1) }}%"></div>
        </div>
        <span class="tier-bar-count count-right">{{ top25_r }}</span>
    </div>
    {% endif %}
    {% set t200 = top200_l + top200_r %}
    {% if t200 > 0 %}
    <div class="tier-bar-row">
        <span class="tier-bar-label rank-silver">Top 200</span>
        <span class="tier-bar-count count-left">{{ top200_l }}</span>
        <div class="tier-bar">
            <div class="tier-fill fill-left" style="width: {{ (top200_l / t200 * 100)|round(1) }}%"></div>
            <div class="tier-fill fill-right" style="width: {{ (top200_r / t200 * 100)|round(1) }}%"></div>
        </div>
        <span class="tier-bar-count count-right">{{ top200_r }}</span>
    </div>
    {% endif %}
    {% set ttot = total_l + total_r %}
    {% if ttot > 0 %}
    <div class="tier-bar-row">
        <span class="tier-bar-label rank-bronze">Top 1000</span>
        <span class="tier-bar-count count-left">{{ total_l }}</span>
        <div class="tier-bar">
            <div class="tier-fill fill-left" style="width: {{ (total_l / ttot * 100)|round(1) }}%"></div>
            <div class="tier-fill fill-right" style="width: {{ (total_r / ttot * 100)|round(1) }}%"></div>
        </div>
        <span class="tier-bar-count count-right">{{ total_r }}</span>
    </div>
    {% endif %}
</div>

<div class="matchup-columns" id="matchup-columns" data-flip="{{ 'true' if flip else 'false' }}">
    {# Left column #}
    <div class="year-column {% if user_voted == left_year %}selected{% endif %}">
        <div class="year-header">
            <h3>{{ left_year }}</h3>
            {% if match.is_active and not match.winner %}
                {% if not user_voted %}
                <button class="vote-btn" data-year="{{ left_year }}" data-match="{{ match.match_id }}">
                    Vote for {{ left_year }}
                </button>
                {% elif user_voted == left_year and not voter_finalized %}
                <button class="vote-btn current-pick" disabled data-year="{{ left_year }}" data-match="{{ match.match_id }}">
                    &#10003; Current pick
                </button>
                {% elif user_voted == left_year and voter_finalized %}
                <mark>Your vote</mark>
                {% elif user_voted == right_year and not voter_finalized %}
                <button class="vote-btn switch-btn" data-year="{{ left_year }}" data-match="{{ match.match_id }}">
                    Switch to {{ left_year }}
                </button>
                {% endif %}
            {% endif %}
        </div>
        <div class="game-grid">
            {% for g in games_left %}
            <a href="https://boardgamegeek.com/boardgame/{{ g.game_id }}" target="_blank" class="game-tile">
                <div class="game-thumb">
                    {% if g.thumbnail_url %}
                    <img src="{{ g.thumbnail_url }}" alt="{{ g.name }}" loading="lazy">
                    {% endif %}
                    <span class="rank-badge {% if g.rank <= 25 %}rank-gold{% elif g.rank <= 200 %}rank-silver{% else %}rank-bronze{% endif %}">#{{ g.rank }}</span>
                </div>
                <span class="game-name">{{ g.name }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="vs-divider">VS</div>

    {# Right column #}
    <div class="year-column {% if user_voted == right_year %}selected{% endif %}">
        <div class="year-header">
            <h3>{{ right_year }}</h3>
            {% if match.is_active and not match.winner %}
                {% if not user_voted %}
                <button class="vote-btn" data-year="{{ right_year }}" data-match="{{ match.match_id }}">
                    Vote for {{ right_year }}
                </button>
                {% elif user_voted == right_year and not voter_finalized %}
                <button class="vote-btn current-pick" disabled data-year="{{ right_year }}" data-match="{{ match.match_id }}">
                    &#10003; Current pick
                </button>
                {% elif user_voted == right_year and voter_finalized %}
                <mark>Your vote</mark>
                {% elif user_voted == left_year and not voter_finalized %}
                <button class="vote-btn switch-btn" data-year="{{ right_year }}" data-match="{{ match.match_id }}">
                    Switch to {{ right_year }}
                </button>
                {% endif %}
            {% endif %}
        </div>
        <div class="game-grid">
            {% for g in games_right %}
            <a href="https://boardgamegeek.com/boardgame/{{ g.game_id }}" target="_blank" class="game-tile">
                <div class="game-thumb">
                    {% if g.thumbnail_url %}
                    <img src="{{ g.thumbnail_url }}" alt="{{ g.name }}" loading="lazy">
                    {% endif %}
                    <span class="rank-badge {% if g.rank <= 25 %}rank-gold{% elif g.rank <= 200 %}rank-silver{% else %}rank-bronze{% endif %}">#{{ g.rank }}</span>
                </div>
                <span class="game-name">{{ g.name }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/vote.js') }}"></script>
<script>
(function () {
    var el = document.getElementById("deadline-timer");
    if (!el) return;
    var deadline = new Date(el.dataset.deadline);
    function update() {
        var diff = deadline - new Date();
        if (diff <= 0) {
            document.getElementById("timer-text").textContent = "Voting is now closed.";
            return;
        }
        var days  = Math.floor(diff / 86400000);
        var hours = Math.floor((diff % 86400000) / 3600000);
        var mins  = Math.floor((diff % 3600000) / 60000);
        var secs  = Math.floor((diff % 60000) / 1000);
        var parts = [];
        if (days > 0) parts.push(days + "d");
        parts.push(String(hours).padStart(2, "0") + "h");
        parts.push(String(mins).padStart(2, "0") + "m");
        parts.push(String(secs).padStart(2, "0") + "s");
        document.getElementById("timer-text").textContent = "Voting closes in " + parts.join(" ");
        setTimeout(update, 1000);
    }
    update();
}());
</script>
{% endblock %}
