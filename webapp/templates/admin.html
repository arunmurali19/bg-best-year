{% extends "base.html" %}

{% block title %}Admin - What's the Good Year?{% endblock %}

{% block content %}
<h1>Admin Dashboard</h1>

<article>
    <h3>Tournament Status</h3>
    <p><strong>Current Round:</strong> {{ current_round }} ({{ round_name }})</p>
    <p><strong>Total Votes:</strong> {{ total_votes }} from {{ unique_voters }} unique voters</p>
    {% if winner %}
    <p><strong>Champion: {{ winner.winner }}</strong></p>
    {% endif %}
</article>

<article>
    <h3>Seedings</h3>
    <table>
        <thead>
            <tr>
                <th>Seed</th>
                <th>Year</th>
            </tr>
        </thead>
        <tbody>
            {% for year, seed in year_seeds.items()|sort(attribute='1') %}
            <tr>
                <td>#{{ seed }}</td>
                <td>{{ year }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>

{% if active and not winner %}
<article>
    <h3>Active Matchups (Round {{ current_round }}{% if wave_info %} — Wave {{ wave_info[0] }} of {{ wave_info[1] }}{% endif %})</h3>
    <table>
        <thead>
            <tr>
                <th>Match</th>
                <th>Year A</th>
                <th>Year B</th>
                <th>Votes A</th>
                <th>Votes B</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for m in active %}
            <tr>
                <td>{{ m.match_id }}</td>
                <td>{{ m.year_a }} <small>(#{{ year_seeds.get(m.year_a, '?') }})</small></td>
                <td>{{ m.year_b }} <small>(#{{ year_seeds.get(m.year_b, '?') }})</small></td>
                <td>{{ m.votes_a }}</td>
                <td>{{ m.votes_b }}</td>
                <td>{{ m.total_votes }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <form method="POST" action="/admin/{{ secret }}/advance"
          onsubmit="return confirm('Close this wave and advance winners?')">
        <button type="submit" class="contrast">
            {% if wave_info %}
            Advance Wave {{ wave_info[0] }} of {{ wave_info[1] }}
            {% else %}
            Advance to Next Round
            {% endif %}
        </button>
    </form>
</article>
{% endif %}

{# ── Completed Rounds with Reveal Controls ── #}
{% if completed_by_round %}
<article>
    <h3>Completed Rounds</h3>
    {% for round_num in completed_by_round.keys()|sort %}
    {% set rd = completed_by_round[round_num] %}
    <details open>
        <summary style="display:flex; align-items:center; gap:1rem; padding:0.5rem 0;">
            <strong>{{ rd.name }}</strong>
            {% if rd.revealed %}
            <span class="reveal-badge">&#10003; Results Revealed</span>
            {% else %}
            <form method="POST" action="/admin/{{ secret }}/reveal/{{ round_num }}" style="margin:0">
                <button type="submit" class="outline" style="margin:0; padding:0.3rem 0.8rem; font-size:0.85rem;">
                    Reveal Results
                </button>
            </form>
            {% endif %}
        </summary>
        <table>
            <thead>
                <tr>
                    <th>Year A</th>
                    <th>Year B</th>
                    <th>Votes A</th>
                    <th>Votes B</th>
                    <th>Winner</th>
                </tr>
            </thead>
            <tbody>
                {% for m in rd.matches %}
                <tr>
                    <td>{{ m.year_a }} <small>(#{{ year_seeds.get(m.year_a, '?') }})</small></td>
                    <td>{{ m.year_b }} <small>(#{{ year_seeds.get(m.year_b, '?') }})</small></td>
                    <td>{{ m.votes_a }}</td>
                    <td>{{ m.votes_b }}</td>
                    <td><strong>{{ m.winner }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </details>
    {% endfor %}
</article>
{% endif %}

{# ── Voting Deadline ── #}
<article>
    <h3>Voting Deadline</h3>
    {% if deadline %}
    <p>Current deadline: <strong>{{ deadline }}</strong></p>
    {% else %}
    <p><small>No deadline set — no countdown timer will be shown to players.</small></p>
    {% endif %}
    <form method="POST" action="/admin/{{ secret }}/set_deadline">
        <label>
            New deadline (your local date &amp; time)
            <input type="datetime-local" name="deadline" value="{{ deadline }}">
        </label>
        <div style="display:flex; gap:1rem; margin-top:0.8rem;">
            <button type="submit">Save Deadline</button>
            <button type="submit" name="deadline" value="" class="outline secondary">Clear Deadline</button>
        </div>
    </form>
</article>

<article>
    <h3>Danger Zone</h3>
    <form method="POST" action="/admin/{{ secret }}/reset"
          onsubmit="return confirm('This will delete ALL votes and reset the tournament. Are you sure?')">
        <button type="submit" class="outline secondary">Reset Entire Tournament</button>
    </form>
</article>
{% endblock %}
